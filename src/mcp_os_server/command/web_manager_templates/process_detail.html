<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MCP Command Server - è¿›ç¨‹è¯¦æƒ…</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
            color: #333;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: #fff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
        }
        .header {
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 20px;
            margin-bottom: 30px;
        }
        h1 {
            color: #2c3e50;
            margin-bottom: 10px;
        }
        .subtitle {
            color: #7f8c8d;
            margin-bottom: 20px;
        }
        .nav-links {
            margin-bottom: 20px;
        }
        .nav-links a {
            color: #007bff;
            text-decoration: none;
            margin-right: 20px;
        }
        .nav-links a:hover {
            text-decoration: underline;
        }
        .info-section {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 6px;
            margin-bottom: 20px;
            border: 1px solid #e9ecef;
        }
        .info-section h3 {
            margin-top: 0;
            color: #495057;
            border-bottom: 1px solid #dee2e6;
            padding-bottom: 10px;
        }
        .info-grid {
            display: grid;
            grid-template-columns: 200px 1fr;
            gap: 10px 20px;
            margin-bottom: 15px;
        }
        .info-label {
            font-weight: 600;
            color: #495057;
        }
        .info-value {
            word-break: break-all;
        }
        .status-running {
            color: #28a745;
            font-weight: bold;
        }
        .status-completed {
            color: #007bff;
        }
        .status-failed, .status-error {
            color: #dc3545;
        }
        .status-terminated {
            color: #fd7e14;
        }
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            text-decoration: none;
            display: inline-block;
            margin-right: 10px;
            margin-bottom: 10px;
            transition: background-color 0.2s;
        }
        .btn-primary {
            background-color: #007bff;
            color: white;
        }
        .btn-primary:hover {
            background-color: #0056b3;
        }
        .btn-danger {
            background-color: #dc3545;
            color: white;
        }
        .btn-danger:hover {
            background-color: #c82333;
        }
        .btn-warning {
            background-color: #fd7e14;
            color: white;
        }
        .btn-warning:hover {
            background-color: #e8610e;
        }
        .btn-success {
            background-color: #28a745;
            color: white;
        }
        .btn-success:hover {
            background-color: #218838;
        }
        .output-section {
            margin-top: 30px;
        }
        .output-controls {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 6px 6px 0 0;
            border: 1px solid #e9ecef;
            border-bottom: none;
        }
        .output-controls label {
            margin-right: 15px;
            font-weight: 500;
        }
        .output-controls input, .output-controls select {
            margin-right: 10px;
            padding: 5px 8px;
            border: 1px solid #ced4da;
            border-radius: 3px;
        }
        .output-display {
            background-color: #212529;
            color: #f8f9fa;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 13px;
            padding: 20px;
            border-radius: 0 0 6px 6px;
            border: 1px solid #e9ecef;
            min-height: 300px;
            max-height: 600px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-break: break-all;
        }
        .output-empty {
            color: #6c757d;
            font-style: italic;
            text-align: center;
            padding: 40px;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            padding: 12px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        .command-display {
            background-color: #e9ecef;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            word-break: break-all;
        }
        .labels {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }
        .label {
            background-color: #007bff;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="nav-links">
                <a href="{{ url_prefix }}/">â† è¿”å›è¿›ç¨‹åˆ—è¡¨</a>
                <a href="#" onclick="refreshDetails()">ğŸ”„ åˆ·æ–°</a>
            </div>
            <h1>è¿›ç¨‹è¯¦æƒ…</h1>
            <p class="subtitle">è¿›ç¨‹ID: <span id="processId">{{ pid }}</span></p>
        </div>

        <div id="errorMessage" class="error" style="display: none;"></div>
        <div id="loadingMessage" class="loading">æ­£åœ¨åŠ è½½è¿›ç¨‹è¯¦æƒ…...</div>

        <div id="processDetails" style="display: none;">
            <!-- åŸºæœ¬ä¿¡æ¯ -->
            <div class="info-section">
                <h3>åŸºæœ¬ä¿¡æ¯</h3>
                <div class="info-grid">
                    <div class="info-label">è¿›ç¨‹ID:</div>
                    <div class="info-value" id="detailPid">-</div>
                    
                    <div class="info-label">çŠ¶æ€:</div>
                    <div class="info-value" id="detailStatus">-</div>
                    
                    <div class="info-label">æè¿°:</div>
                    <div class="info-value" id="detailDescription">-</div>
                    
                    <div class="info-label">å‘½ä»¤:</div>
                    <div class="info-value">
                        <div id="detailCommand" class="command-display">-</div>
                    </div>
                    
                    <div class="info-label">å·¥ä½œç›®å½•:</div>
                    <div class="info-value" id="detailDirectory">-</div>
                    
                    <div class="info-label">æ ‡ç­¾:</div>
                    <div class="info-value">
                        <div id="detailLabels" class="labels">-</div>
                    </div>
                </div>
            </div>

            <!-- æ—¶é—´ä¿¡æ¯ -->
            <div class="info-section">
                <h3>æ—¶é—´ä¿¡æ¯</h3>
                <div class="info-grid">
                    <div class="info-label">å¼€å§‹æ—¶é—´:</div>
                    <div class="info-value" id="detailStartTime">-</div>
                    
                    <div class="info-label">ç»“æŸæ—¶é—´:</div>
                    <div class="info-value" id="detailEndTime">-</div>
                    
                    <div class="info-label">è¿è¡Œæ—¶é•¿:</div>
                    <div class="info-value" id="detailDuration">-</div>
                    
                    <div class="info-label">é€€å‡ºç :</div>
                    <div class="info-value" id="detailExitCode">-</div>
                    
                    <div class="info-label">è¶…æ—¶è®¾ç½®:</div>
                    <div class="info-value" id="detailTimeout">-</div>
                </div>
            </div>

            <!-- æ§åˆ¶æ“ä½œ -->
            <div class="info-section">
                <h3>æ§åˆ¶æ“ä½œ</h3>
                <div id="processControls">
                    <!-- æ§åˆ¶æŒ‰é’®å°†ç”±JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>

            <!-- è¾“å‡ºæŸ¥çœ‹ -->
            <div class="output-section">
                <h3>è¿›ç¨‹è¾“å‡º</h3>
                <div class="output-controls">
                    <label>
                        <input type="checkbox" id="showStdout" checked> æ˜¾ç¤ºæ ‡å‡†è¾“å‡º
                    </label>
                    <label>
                        <input type="checkbox" id="showStderr"> æ˜¾ç¤ºé”™è¯¯è¾“å‡º
                    </label>
                    <label>
                        è¡Œæ•°é™åˆ¶: <input type="number" id="tailLines" value="100" min="1" max="1000" style="width: 80px;">
                    </label>
                    <button class="btn btn-primary" onclick="loadOutput()">åˆ·æ–°è¾“å‡º</button>
                    <button class="btn btn-success" onclick="toggleAutoRefresh()">å¼€å¯è‡ªåŠ¨åˆ·æ–°</button>
                </div>
                <div id="outputDisplay" class="output-display">
                    <div class="output-empty">ç‚¹å‡»"åˆ·æ–°è¾“å‡º"æŸ¥çœ‹è¿›ç¨‹è¾“å‡º</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ä¿å­˜URLå‰ç¼€å’Œè¿›ç¨‹ID
        const urlPrefix = "{{ url_prefix }}";
        const processId = "{{ pid }}";
        let autoRefreshInterval = null;
        let isAutoRefreshing = false;

        // é¡µé¢åŠ è½½å®Œæˆåè·å–è¿›ç¨‹è¯¦æƒ…
        document.addEventListener('DOMContentLoaded', function() {
            loadProcessDetails();
        });

        // åˆ·æ–°è¿›ç¨‹è¯¦æƒ…
        function refreshDetails() {
            loadProcessDetails();
            if (document.getElementById('outputDisplay').textContent.trim() !== 'ç‚¹å‡»"åˆ·æ–°è¾“å‡º"æŸ¥çœ‹è¿›ç¨‹è¾“å‡º') {
                loadOutput();
            }
        }

        // åŠ è½½è¿›ç¨‹è¯¦æƒ…
        function loadProcessDetails() {
            hideError();
            document.getElementById('loadingMessage').style.display = 'block';
            document.getElementById('processDetails').style.display = 'none';

            fetch(`${urlPrefix}/api/processes/${processId}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.error) {
                        throw new Error(data.error);
                    }
                    displayProcessDetails(data.data);
                })
                .catch(error => {
                    console.error('è·å–è¿›ç¨‹è¯¦æƒ…å¤±è´¥:', error);
                    showError(`è·å–è¿›ç¨‹è¯¦æƒ…å¤±è´¥: ${error.message}`);
                    document.getElementById('loadingMessage').style.display = 'none';
                });
        }

        // æ˜¾ç¤ºè¿›ç¨‹è¯¦æƒ…
        function displayProcessDetails(process) {
            document.getElementById('loadingMessage').style.display = 'none';
            document.getElementById('processDetails').style.display = 'block';

            // åŸºæœ¬ä¿¡æ¯
            document.getElementById('detailPid').textContent = process.pid || '-';
            
            const statusElement = document.getElementById('detailStatus');
            const statusValue = process.status || 'UNKNOWN';
            statusElement.textContent = statusValue;
            statusElement.className = 'info-value status-' + statusValue.toLowerCase();
            
            document.getElementById('detailDescription').textContent = process.description || '-';
            
            // å‘½ä»¤æ˜¾ç¤º
            let commandDisplay = '';
            if (Array.isArray(process.command)) {
                commandDisplay = process.command.join(' ');
            } else {
                commandDisplay = process.command || '-';
            }
            document.getElementById('detailCommand').textContent = commandDisplay;
            
            document.getElementById('detailDirectory').textContent = process.directory || '-';
            
            // æ ‡ç­¾æ˜¾ç¤º
            const labelsContainer = document.getElementById('detailLabels');
            if (process.labels && process.labels.length > 0) {
                labelsContainer.innerHTML = '';
                process.labels.forEach(label => {
                    const labelElement = document.createElement('div');
                    labelElement.className = 'label';
                    labelElement.textContent = label;
                    labelsContainer.appendChild(labelElement);
                });
            } else {
                labelsContainer.innerHTML = '<span style="color: #6c757d; font-style: italic;">æ— æ ‡ç­¾</span>';
            }

            // æ—¶é—´ä¿¡æ¯
            document.getElementById('detailStartTime').textContent = formatDateTime(process.start_time) || '-';
            document.getElementById('detailEndTime').textContent = formatDateTime(process.end_time) || '-';
            
            // è®¡ç®—è¿è¡Œæ—¶é•¿
            if (process.start_time) {
                const startTime = new Date(process.start_time);
                const endTime = process.end_time ? new Date(process.end_time) : new Date();
                const duration = Math.floor((endTime - startTime) / 1000); // ç§’æ•°
                document.getElementById('detailDuration').textContent = formatDuration(duration);
            } else {
                document.getElementById('detailDuration').textContent = '-';
            }
            
            document.getElementById('detailExitCode').textContent = 
                process.exit_code !== null && process.exit_code !== undefined ? process.exit_code : '-';
            document.getElementById('detailTimeout').textContent = 
                process.timeout ? `${process.timeout}ç§’` : 'æ— é™åˆ¶';

            // ç”Ÿæˆæ§åˆ¶æŒ‰é’®
            generateControlButtons(process);
        }

        // ç”Ÿæˆæ§åˆ¶æŒ‰é’®
        function generateControlButtons(process) {
            const controlsContainer = document.getElementById('processControls');
            const status = process.status || '';
            
            let buttonsHtml = '';
            
            if (status.toLowerCase() === 'running') {
                buttonsHtml += '<button class="btn btn-danger" onclick="stopProcess(false)">ä¼˜é›…åœæ­¢</button>';
                buttonsHtml += '<button class="btn btn-warning" onclick="stopProcess(true)">å¼ºåˆ¶ç»ˆæ­¢</button>';
            } else {
                buttonsHtml += '<button class="btn btn-primary" onclick="cleanProcess()">æ¸…ç†è¿›ç¨‹</button>';
            }
            
            controlsContainer.innerHTML = buttonsHtml;
        }

        // æ ¼å¼åŒ–æ—¶é—´æ˜¾ç¤º
        function formatDateTime(dateString) {
            if (!dateString) return null;
            
            try {
                const date = new Date(dateString);
                if (isNaN(date.getTime())) return dateString;
                
                return date.toLocaleString('zh-CN', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
            } catch (e) {
                return dateString;
            }
        }

        // æ ¼å¼åŒ–æ—¶é•¿æ˜¾ç¤º
        function formatDuration(seconds) {
            if (seconds < 60) {
                return `${seconds}ç§’`;
            } else if (seconds < 3600) {
                const minutes = Math.floor(seconds / 60);
                const remainingSeconds = seconds % 60;
                return `${minutes}åˆ†${remainingSeconds}ç§’`;
            } else {
                const hours = Math.floor(seconds / 3600);
                const minutes = Math.floor((seconds % 3600) / 60);
                const remainingSeconds = seconds % 60;
                return `${hours}æ—¶${minutes}åˆ†${remainingSeconds}ç§’`;
            }
        }

        // åœæ­¢è¿›ç¨‹
        function stopProcess(force) {
            const action = force ? 'å¼ºåˆ¶ç»ˆæ­¢' : 'ä¼˜é›…åœæ­¢';
            if (!confirm(`ç¡®å®šè¦${action}è¿›ç¨‹ ${processId} å—ï¼Ÿ`)) {
                return;
            }

            fetch(`${urlPrefix}/api/processes/${processId}/stop`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ force: force })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert(`${action}å¤±è´¥: ${data.error}`);
                } else {
                    alert(`è¿›ç¨‹ ${processId} å·²${action}`);
                    loadProcessDetails(); // åˆ·æ–°è¯¦æƒ…
                }
            })
            .catch(error => {
                console.error(`${action}å¤±è´¥:`, error);
                alert(`${action}å¤±è´¥: ${error.message}`);
            });
        }

        // æ¸…ç†è¿›ç¨‹
        function cleanProcess() {
            if (!confirm(`ç¡®å®šè¦æ¸…ç†è¿›ç¨‹ ${processId} å—ï¼Ÿæ­¤æ“ä½œå°†åˆ é™¤æ‰€æœ‰ç›¸å…³æ•°æ®ã€‚`)) {
                return;
            }

            fetch(`${urlPrefix}/api/processes/${processId}/clean`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert(`æ¸…ç†è¿›ç¨‹å¤±è´¥: ${data.error}`);
                } else {
                    alert(`è¿›ç¨‹ ${processId} å·²æ¸…ç†`);
                    // æ¸…ç†æˆåŠŸåè¿”å›åˆ—è¡¨é¡µé¢
                    window.location.href = `${urlPrefix}/`;
                }
            })
            .catch(error => {
                console.error('æ¸…ç†è¿›ç¨‹å¤±è´¥:', error);
                alert(`æ¸…ç†è¿›ç¨‹å¤±è´¥: ${error.message}`);
            });
        }

        // åŠ è½½è¾“å‡º
        function loadOutput() {
            const showStdout = document.getElementById('showStdout').checked;
            const showStderr = document.getElementById('showStderr').checked;
            const tailLines = parseInt(document.getElementById('tailLines').value) || 100;

            if (!showStdout && !showStderr) {
                document.getElementById('outputDisplay').innerHTML = 
                    '<div class="output-empty">è¯·è‡³å°‘é€‰æ‹©ä¸€ç§è¾“å‡ºç±»å‹</div>';
                return;
            }

            const params = new URLSearchParams();
            params.append('with_stdout', showStdout.toString());
            params.append('with_stderr', showStderr.toString());
            params.append('tail', tailLines.toString());

            document.getElementById('outputDisplay').innerHTML = 
                '<div class="loading">æ­£åœ¨åŠ è½½è¾“å‡º...</div>';

            fetch(`${urlPrefix}/api/processes/${processId}/output?${params.toString()}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.error) {
                        throw new Error(data.error);
                    }
                    displayOutput(data.data, showStdout, showStderr);
                })
                .catch(error => {
                    console.error('è·å–è¾“å‡ºå¤±è´¥:', error);
                    document.getElementById('outputDisplay').innerHTML = 
                        `<div class="error">è·å–è¾“å‡ºå¤±è´¥: ${error.message}</div>`;
                });
        }

        // æ˜¾ç¤ºè¾“å‡º
        function displayOutput(data, showStdout, showStderr) {
            const outputDisplay = document.getElementById('outputDisplay');
            let content = '';

            if (showStdout && data.stdout && data.stdout.length > 0) {
                content += '=== æ ‡å‡†è¾“å‡º ===\n';
                data.stdout.forEach(entry => {
                    const timestamp = formatDateTime(entry.timestamp);
                    content += `[${timestamp}] ${entry.content}\n`;
                });
                content += '\n';
            }

            if (showStderr && data.stderr && data.stderr.length > 0) {
                content += '=== é”™è¯¯è¾“å‡º ===\n';
                data.stderr.forEach(entry => {
                    const timestamp = formatDateTime(entry.timestamp);
                    content += `[${timestamp}] ${entry.content}\n`;
                });
                content += '\n';
            }

            if (!content.trim()) {
                content = 'æš‚æ— è¾“å‡ºæ•°æ®';
            }

            outputDisplay.textContent = content;
            // æ»šåŠ¨åˆ°åº•éƒ¨
            outputDisplay.scrollTop = outputDisplay.scrollHeight;
        }

        // åˆ‡æ¢è‡ªåŠ¨åˆ·æ–°
        function toggleAutoRefresh() {
            const button = event.target;
            
            if (isAutoRefreshing) {
                // åœæ­¢è‡ªåŠ¨åˆ·æ–°
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
                isAutoRefreshing = false;
                button.textContent = 'å¼€å¯è‡ªåŠ¨åˆ·æ–°';
                button.className = 'btn btn-success';
            } else {
                // å¼€å§‹è‡ªåŠ¨åˆ·æ–°
                autoRefreshInterval = setInterval(() => {
                    loadProcessDetails();
                    loadOutput();
                }, 5000); // æ¯5ç§’åˆ·æ–°ä¸€æ¬¡
                isAutoRefreshing = true;
                button.textContent = 'åœæ­¢è‡ªåŠ¨åˆ·æ–°';
                button.className = 'btn btn-warning';
            }
        }

        // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        // éšè—é”™è¯¯ä¿¡æ¯
        function hideError() {
            document.getElementById('errorMessage').style.display = 'none';
        }
    </script>
</body>
</html> 